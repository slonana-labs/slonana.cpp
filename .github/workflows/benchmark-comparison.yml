name: Real Benchmark Comparison - Slonana vs Agave

on:
  push:
    branches: [ main, copilot/fix-26 ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write  # Required to push benchmark results back to the repository

concurrency:
  group: benchmark-${{ github.ref }}
  cancel-in-progress: false  # Let running jobs finish; queue new ones

jobs:
  benchmark-comparison:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Reduced from 620 to prevent excessive timeout issues

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          pkg-config \
          libssl-dev \
          libcurl4-openssl-dev \
          libjsoncpp-dev \
          libprotobuf-dev \
          protobuf-compiler \
          libudev-dev \
          libusb-1.0-0-dev \
          nlohmann-json3-dev \
          libsodium-dev \
          curl \
          wget \
          git \
          htop \
          time \
          jq

    - name: Install Rust for Agave validator
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true

    - name: Cache cargo registry and binaries
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          ~/.cargo/bin
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-agave-v3.0
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Install Solana CLI
      run: |
        echo "üîç Installing Solana CLI with full tool suite..."
        # Pin to specific version for reproducibility and to ensure all tools are available
        sh -c "$(curl -sSfL https://release.anza.xyz/v1.18.22/install)"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        
        # Verify Solana CLI installation with fail-fast
        echo "üîç Verifying Solana CLI installation..."
        which solana || { echo "‚ùå Solana CLI install failed"; exit 1; }
        which solana-keygen || { echo "‚ùå solana-keygen not found"; exit 1; }
        which solana-genesis || { echo "‚ùå solana-genesis not found"; exit 1; }
        
        echo "‚úÖ Solana CLI installed successfully"
        solana --version
        solana-keygen --version
        solana-genesis --version

    - name: Ensure Solana/Agave binaries available for all steps
      run: |
        echo "üîç Guaranteeing CLI binaries in every step..."
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        
        echo "‚úÖ Solana CLI binaries configured for all subsequent steps"

    - name: Build Slonana validator
      run: |
        mkdir -p build
        cd build
        cmake -DCMAKE_BUILD_TYPE=Release -GNinja ..
        ninja -j$(nproc)
        sudo cp slonana_validator /usr/local/bin/slonana-validator || true
        sudo cp slonana_benchmarks /usr/local/bin/slonana-benchmarks || true

    - name: Prepare benchmark environment
      run: |
        mkdir -p benchmark_results/{agave,slonana}
        mkdir -p test_ledgers/{agave,slonana}
        cat > benchmark_config.json << EOF
        {
          "test_duration_seconds": 500,
          "target_tps": [1000, 5000, 10000, 25000, 50000],
          "concurrent_connections": [10, 50, 100],
          "transaction_types": ["transfer", "token_transfer", "vote"],
          "measurement_interval_seconds": 10
        }
        EOF

    - name: Make benchmark scripts executable
      run: |
        echo "üîç Making benchmark scripts executable..."
        chmod +x ./scripts/benchmark_agave.sh
        chmod +x ./scripts/benchmark_slonana.sh
        
        # Verify scripts are executable
        if [[ -x "./scripts/benchmark_agave.sh" && -x "./scripts/benchmark_slonana.sh" ]]; then
          echo "‚úÖ Both benchmark scripts are executable"
        else
          echo "‚ùå Benchmark scripts are not executable"
          exit 1
        fi

    - name: Validate benchmark dependencies
      run: |
        echo "üîç Validating all benchmark dependencies..."
        echo "Current PATH: $PATH"
        echo ""
        
        # Check all required binaries before proceeding
        echo "üîç Checking required binaries..."
        which solana || { echo "‚ùå solana not found"; exit 1; }
        which solana-keygen || { echo "‚ùå solana-keygen not found"; exit 1; }
        which solana-genesis || { echo "‚ùå solana-genesis not found"; exit 1; }
        which solana-test-validator || { echo "‚ùå solana-test-validator not found"; exit 1; }
        which agave-ledger-tool || { echo "‚ùå agave-ledger-tool not found"; exit 1; }
        
        echo "‚úÖ All required binaries found:"
        echo "  solana: $(which solana)"
        echo "  solana-keygen: $(which solana-keygen)"
        echo "  solana-genesis: $(which solana-genesis)"
        echo "  solana-test-validator: $(which solana-test-validator)"
        echo "  agave-ledger-tool: $(which agave-ledger-tool)"
        echo ""
        
        # Test help functionality
        echo "üîç Testing benchmark scripts..."
        ./scripts/benchmark_agave.sh --help > /dev/null
        echo "‚úÖ Agave benchmark script help works"
        
        ./scripts/benchmark_slonana.sh --help > /dev/null
        echo "‚úÖ Slonana benchmark script help works"
        echo ""
        
        # Version validation
        echo "üîç Version information:"
        solana --version
        solana-genesis --version
        solana-test-validator --version
        echo ""
        
        echo "‚úÖ All dependencies validated successfully - ready for benchmarking!"

    - name: Run Slonana validator benchmark
      timeout-minutes: 20
      run: |
        echo "üîç Running Slonana validator benchmark..."
        
        # Ensure PATH includes Solana CLI (which includes Agave binaries)  
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        
        # Set environment variables for proper CI benchmarking
        export SLONANA_CI_MODE=1
        export CI=true
        
        if [ -f "build/slonana_validator" ]; then
          timeout 900s ./scripts/benchmark_slonana.sh \
            --ledger test_ledgers/slonana \
            --results benchmark_results/slonana \
            --validator-bin build/slonana_validator \
            --test-duration 60 \
            --verbose
        else
          echo "Slonana validator not found, using placeholder mode..."
          timeout 900s ./scripts/benchmark_slonana.sh \
            --ledger test_ledgers/slonana \
            --results benchmark_results/slonana \
            --test-duration 60 \
            --use-placeholder \
            --verbose
        fi

    - name: Run 3-Node Localnet Cluster Test
      timeout-minutes: 15
      run: |
        echo "üåê Running 3-Node Localnet Cluster Test..."
        echo "   This tests actual network TPS with peer-to-peer communication"
        
        # Ensure PATH includes Solana CLI
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        
        # Make the localnet test script executable
        chmod +x ./scripts/test_localnet_cluster.sh
        
        # Run the localnet cluster test with native binaries
        # Reduced load for CI: 2k transactions @ 1k/sec (completes in ~3 minutes)
        # CI runners have limited resources, so we use conservative settings
        if [ -f "build/slonana_validator" ]; then
          timeout 600s ./scripts/test_localnet_cluster.sh \
            --test-duration 30 \
            --tx-count 2000 \
            --tx-rate 1000 \
            --skip-build
        else
          echo "‚ö†Ô∏è  Slonana validator not built, skipping localnet test"
          echo "   Building is required for localnet cluster testing"
        fi
        
        # Show test results
        if [ -f "/tmp/slonana_localnet_cluster/test_report.txt" ]; then
          echo ""
          echo "üìä Localnet Cluster Test Report:"
          cat /tmp/slonana_localnet_cluster/test_report.txt
        fi
        
        # Cleanup the cluster
        ./scripts/test_localnet_cluster.sh --cleanup-only 2>/dev/null || true

    - name: Run Agave validator benchmark
      timeout-minutes: 20
      run: |
        echo "üîç Running Agave validator benchmark..."
        
        # Ensure PATH includes Solana CLI (which includes Agave binaries)
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        
        # Set environment variables for proper CI benchmarking
        export SLONANA_CI_MODE=1
        export CI=true
        
        timeout 900s ./scripts/benchmark_agave.sh \
          --ledger test_ledgers/agave \
          --results benchmark_results/agave \
          --validator-bin solana-test-validator \
          --test-duration 60 \
          --verbose
          
    - name: Generate comparison report
      run: |
        echo "üìä Generating benchmark comparison report..."

        # Validate result files exist and contain valid JSON, default to safe values if missing
        AGAVE_FILE="benchmark_results/agave/benchmark_results.json"
        SLONANA_FILE="benchmark_results/slonana/benchmark_results.json"

        if [ -s "$AGAVE_FILE" ] && jq -e . >/dev/null 2>&1 <"$AGAVE_FILE"; then
          AGAVE_TPS=$(jq -r '.effective_tps // 0' "$AGAVE_FILE")
          AGAVE_LATENCY=$(jq -r '.rpc_latency_ms // 0' "$AGAVE_FILE")
          AGAVE_MEMORY=$(jq -r '.memory_usage_mb // 0' "$AGAVE_FILE")
          AGAVE_CPU=$(jq -r '.cpu_usage_percent // 0' "$AGAVE_FILE")
        else
          echo "‚ö†Ô∏è Agave results missing/invalid, defaulting metrics to 0"
          AGAVE_TPS=0; AGAVE_LATENCY=0; AGAVE_MEMORY=0; AGAVE_CPU=0
        fi

        if [ -s "$SLONANA_FILE" ] && jq -e . >/dev/null 2>&1 <"$SLONANA_FILE"; then
          SLONANA_TPS=$(jq -r '.effective_tps // 0' "$SLONANA_FILE")
          SLONANA_LATENCY=$(jq -r '.rpc_latency_ms // 0' "$SLONANA_FILE")
          SLONANA_MEMORY=$(jq -r '.memory_usage_mb // 0' "$SLONANA_FILE")
          SLONANA_CPU=$(jq -r '.cpu_usage_percent // 0' "$SLONANA_FILE")
        else
          echo "‚ö†Ô∏è Slonana results missing/invalid, defaulting metrics to 0"
          SLONANA_TPS=0; SLONANA_LATENCY=0; SLONANA_MEMORY=0; SLONANA_CPU=0
        fi

        # Convert null to 0 for any null values that slipped through
        AGAVE_TPS=${AGAVE_TPS:-0}; [ "$AGAVE_TPS" = "null" ] && AGAVE_TPS=0
        AGAVE_LATENCY=${AGAVE_LATENCY:-0}; [ "$AGAVE_LATENCY" = "null" ] && AGAVE_LATENCY=0
        AGAVE_MEMORY=${AGAVE_MEMORY:-0}; [ "$AGAVE_MEMORY" = "null" ] && AGAVE_MEMORY=0
        AGAVE_CPU=${AGAVE_CPU:-0}; [ "$AGAVE_CPU" = "null" ] && AGAVE_CPU=0
        SLONANA_TPS=${SLONANA_TPS:-0}; [ "$SLONANA_TPS" = "null" ] && SLONANA_TPS=0
        SLONANA_LATENCY=${SLONANA_LATENCY:-0}; [ "$SLONANA_LATENCY" = "null" ] && SLONANA_LATENCY=0
        SLONANA_MEMORY=${SLONANA_MEMORY:-0}; [ "$SLONANA_MEMORY" = "null" ] && SLONANA_MEMORY=0
        SLONANA_CPU=${SLONANA_CPU:-0}; [ "$SLONANA_CPU" = "null" ] && SLONANA_CPU=0

        echo "üìä Parsed values:"
        echo "   Agave:   TPS=$AGAVE_TPS, Latency=$AGAVE_LATENCY, Memory=$AGAVE_MEMORY, CPU=$AGAVE_CPU"
        echo "   Slonana: TPS=$SLONANA_TPS, Latency=$SLONANA_LATENCY, Memory=$SLONANA_MEMORY, CPU=$SLONANA_CPU"

        # Safe improvement calculations - guard against divide-by-zero
        if [ "$AGAVE_TPS" != "0" ] && [ -n "$AGAVE_TPS" ]; then
          TPS_IMPROVEMENT=$(echo "scale=1; ($SLONANA_TPS - $AGAVE_TPS) * 100 / $AGAVE_TPS" | bc -l 2>/dev/null || echo "0")
        else
          TPS_IMPROVEMENT="0"
          echo "‚ö†Ô∏è Agave TPS is 0, setting TPS improvement to 0%"
        fi

        if [ "$AGAVE_LATENCY" != "0" ] && [ -n "$AGAVE_LATENCY" ]; then
          LATENCY_IMPROVEMENT=$(echo "scale=1; ($AGAVE_LATENCY - $SLONANA_LATENCY) * 100 / $AGAVE_LATENCY" | bc -l 2>/dev/null || echo "0")
        else
          LATENCY_IMPROVEMENT="0"
          echo "‚ö†Ô∏è Agave Latency is 0, setting latency improvement to 0%"
        fi

        if [ "$AGAVE_MEMORY" != "0" ] && [ -n "$AGAVE_MEMORY" ]; then
          MEMORY_IMPROVEMENT=$(echo "scale=1; ($AGAVE_MEMORY - $SLONANA_MEMORY) * 100 / $AGAVE_MEMORY" | bc -l 2>/dev/null || echo "0")
        else
          MEMORY_IMPROVEMENT="0"
          echo "‚ö†Ô∏è Agave Memory is 0, setting memory improvement to 0%"
        fi

        # Ensure improvement values are valid numbers (not empty)
        TPS_IMPROVEMENT=${TPS_IMPROVEMENT:-0}
        LATENCY_IMPROVEMENT=${LATENCY_IMPROVEMENT:-0}
        MEMORY_IMPROVEMENT=${MEMORY_IMPROVEMENT:-0}

        # Use jq to create valid JSON (safer than heredoc)
        jq -n \
          --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
          --argjson cores "$(nproc)" \
          --argjson memory_gb "$(echo "$(free -m | awk '/^Mem:/{print $2}') / 1024" | bc)" \
          --argjson agave_tps "${AGAVE_TPS}" \
          --argjson agave_latency "${AGAVE_LATENCY}" \
          --argjson agave_memory "${AGAVE_MEMORY}" \
          --argjson agave_cpu "${AGAVE_CPU}" \
          --argjson slonana_tps "${SLONANA_TPS}" \
          --argjson slonana_latency "${SLONANA_LATENCY}" \
          --argjson slonana_memory "${SLONANA_MEMORY}" \
          --argjson slonana_cpu "${SLONANA_CPU}" \
          --argjson tps_imp "${TPS_IMPROVEMENT}" \
          --argjson latency_imp "${LATENCY_IMPROVEMENT}" \
          --argjson memory_imp "${MEMORY_IMPROVEMENT}" \
          '{
            benchmark_date: $date,
            environment: {
              runner: "GitHub Actions - ubuntu-latest",
              cores: $cores,
              memory_gb: $memory_gb
            },
            results: {
              agave: {
                tps: $agave_tps,
                rpc_latency_ms: $agave_latency,
                memory_usage_mb: $agave_memory,
                cpu_usage_percent: $agave_cpu
              },
              slonana: {
                tps: $slonana_tps,
                rpc_latency_ms: $slonana_latency,
                memory_usage_mb: $slonana_memory,
                cpu_usage_percent: $slonana_cpu
              },
              improvements: {
                tps_percent: $tps_imp,
                latency_percent: $latency_imp,
                memory_percent: $memory_imp
              }
            }
          }' > benchmark_comparison.json

        echo "üìà Benchmark comparison completed!"
        echo "Agave TPS: $AGAVE_TPS | Slonana TPS: $SLONANA_TPS (${TPS_IMPROVEMENT}% improvement)"
        echo "Agave Latency: ${AGAVE_LATENCY}ms | Slonana Latency: ${SLONANA_LATENCY}ms (${LATENCY_IMPROVEMENT}% improvement)"
        echo "Agave Memory: ${AGAVE_MEMORY}MB | Slonana Memory: ${SLONANA_MEMORY}MB (${MEMORY_IMPROVEMENT}% improvement)"

    - name: Update README with real benchmark results
      run: |
        echo "üìù Updating README.md with real benchmark results..."

        COMPARISON=$(cat benchmark_comparison.json)

        AGAVE_TPS=$(echo $COMPARISON | jq -r '.results.agave.tps')
        AGAVE_LATENCY=$(echo $COMPARISON | jq -r '.results.agave.rpc_latency_ms')
        AGAVE_MEMORY=$(echo $COMPARISON | jq -r '.results.agave.memory_usage_mb')

        SLONANA_TPS=$(echo $COMPARISON | jq -r '.results.slonana.tps')
        SLONANA_LATENCY=$(echo $COMPARISON | jq -r '.results.slonana.rpc_latency_ms')
        SLONANA_MEMORY=$(echo $COMPARISON | jq -r '.results.slonana.memory_usage_mb')

        TPS_IMPROVEMENT=$(echo $COMPARISON | jq -r '.results.improvements.tps_percent')
        LATENCY_IMPROVEMENT=$(echo $COMPARISON | jq -r '.results.improvements.latency_percent')
        MEMORY_IMPROVEMENT=$(echo $COMPARISON | jq -r '.results.improvements.memory_percent')

        BENCHMARK_DATE=$(echo $COMPARISON | jq -r '.benchmark_date' | cut -d'T' -f1)

        sed -i "/| Metric | Slonana.cpp | Anza\/Agave | Improvement |/,/| \*\*Test Reliability\*\*/ {
          s/| \*\*Transaction Processing\*\* | [^|]* | [^|]* | [^|]* |/| **Transaction Processing** | $SLONANA_TPS TPS | $AGAVE_TPS TPS | **${TPS_IMPROVEMENT}% faster** |/
          s/| \*\*RPC Response Time\*\* | [^|]* | [^|]* | [^|]* |/| **RPC Response Time** | ${SLONANA_LATENCY}ms | ${AGAVE_LATENCY}ms | **${LATENCY_IMPROVEMENT}% faster** |/
          s/| \*\*Memory Usage\*\* | [^|]* | [^|]* | [^|]* |/| **Memory Usage** | ${SLONANA_MEMORY}MB baseline | ${AGAVE_MEMORY}MB | **${MEMORY_IMPROVEMENT}% more efficient** |/
        }" README.md

        echo "# Adding benchmark date note to README..."
        TEMP_NOTE="\\n> **Real Benchmark Results** *(Last Updated: $BENCHMARK_DATE)*  \\n> Automated comparison against Anza/Agave validator using GitHub Actions on ubuntu-latest runners.\\n"
        sed -i "/## üìä Performance/a $TEMP_NOTE" README.md

    - name: Update landing page with real benchmark results  
      run: |
        echo "üåê Updating docs/index.html with real benchmark results..."

        COMPARISON=$(cat benchmark_comparison.json)

        SLONANA_TPS=$(echo $COMPARISON | jq -r '.results.slonana.tps')
        AGAVE_TPS=$(echo $COMPARISON | jq -r '.results.agave.tps')

        sed -i "s/65,000 TPS/${SLONANA_TPS} TPS/g" docs/index.html
        sed -i "s/50,000 TPS/${AGAVE_TPS} TPS/g" docs/index.html

        BENCH_NOTE="                        <p><em>Real benchmark results from automated GitHub Actions testing against Anza/Agave validator. Last updated: $(date +%Y-%m-%d)</em></p>"
        sed -i "/Performance Benchmarks (Production Verified)/a $BENCH_NOTE" docs/index.html

    - name: Commit updated benchmark results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        git add README.md docs/index.html benchmark_comparison.json

        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "üîÄ Update benchmark results with real Agave vs Slonana comparison

          - Agave TPS: $(jq -r '.results.agave.tps' benchmark_comparison.json)
          - Slonana TPS: $(jq -r '.results.slonana.tps' benchmark_comparison.json)  
          - Improvement: $(jq -r '.results.improvements.tps_percent' benchmark_comparison.json)%
          - Memory efficiency: $(jq -r '.results.improvements.memory_percent' benchmark_comparison.json)%
          - Latency improvement: $(jq -r '.results.improvements.latency_percent' benchmark_comparison.json)%

          Automated benchmark comparison run on $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          
          # Determine target branch
          if [ -n "$GITHUB_HEAD_REF" ]; then
            TARGET_BRANCH="$GITHUB_HEAD_REF"
          elif [ -n "$GITHUB_REF_NAME" ]; then
            TARGET_BRANCH="$GITHUB_REF_NAME"
          else
            TARGET_BRANCH="main"
          fi
          
          echo "üîÑ Syncing with remote branch $TARGET_BRANCH before push..."
          
          # Ensure no unstaged changes exist before rebase (prevents rebase conflicts)
          if ! git diff-index --quiet HEAD; then
            echo "‚ö†Ô∏è Unstaged changes detected, committing them before sync..."
            git add -A
            git commit -m "ci: save benchmark artifacts before sync" || true
          fi
          
          # Fetch latest remote state
          git fetch origin "$TARGET_BRANCH"
          
          # Try fast-forward merge first (safest)
          if git merge --ff-only "origin/$TARGET_BRANCH" 2>/dev/null; then
            echo "‚úÖ Fast-forward merge successful"
          else
            echo "‚ö†Ô∏è Cannot fast-forward, attempting rebase..."
            # Rebase our commit on top of remote changes
            if git rebase "origin/$TARGET_BRANCH"; then
              echo "‚úÖ Rebase successful"
            else
              echo "‚ùå Rebase failed with conflicts. Aborting to prevent data loss."
              git rebase --abort
              echo "::warning::Benchmark results could not be pushed due to conflicts. Manual intervention required."
              exit 1  # Fail the job explicitly rather than force-pushing
            fi
          fi
          
          # Push only if we successfully synced
          echo "üì§ Pushing to origin/$TARGET_BRANCH..."
          git push origin "HEAD:$TARGET_BRANCH"
        fi

    - name: Upload benchmark artifacts
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results-${{ github.run_number }}
        path: |
          benchmark_results/
          benchmark_comparison.json
        retention-days: 30
